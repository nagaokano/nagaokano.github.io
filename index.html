<!doctype html>
<!--
Copyright 2020 Beacon Technologies & JellyWare Inc.
-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="BLE Gas Sensor">
    <meta name="viewport" content="width=640, maximum-scale=1.0, user-scalable=yes">
    <title>BlueJelly</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.css">
    <!--BlueJellyの呼び出し-->
    <script type="text/javascript" src="bluejelly.js"></script>
    <!--Smooth Chartsの呼び出し-->
    <script type="text/javascript" src="./smoothie.js"></script>
</head>

<body>
    <div class="container">
        <div class="title margin">
            <p id="title">BLE Gas Sensor</p>
            <p id="subtitle">可燃ガス濃度</p>
        </div>
        <div class="contents margin">
            <button id="Start" class="button">Start</button>
            <button id="Stop" class="button">Stop</button>
            <hr>
            <div id="device_name">xxxx</div>
            <div id="uuid_name">xxxx</div>
            <div id="data_text">xxxx</div>
            <div id="status">xxxx</div>
            <hr>
            <!--CANVASを準備-->
            <canvas id="canvas" width="500" height="320"></canvas>

        </div>
        <div class="footer margin">
          &copy; 2020 <a href="http://www.beacon-tech.co.jp/" target="_blank">Beacon Technologies, Inc</a> All Rights Reserved
        </div>
    </div>
    <script>
        //--------------------------------------------------
        //Global変数
        //--------------------------------------------------
        //BlueJellyのインスタンス生成
        var ble = new BlueJelly();
        //時系列オブジェクトの生成
        var ble_data = new TimeSeries();

        //-------------------------------------------------
        //Smooth Charts初期化関数
        //-------------------------------------------------
        function initSmoothCharts() {
            //chart(SmoothieChartの背景/軸のインスタンス)生成
            var chart = new SmoothieChart({
                millisPerPixel: 20,             // ms/Pixel　横軸ロール速度
                grid: {
                    fillStyle: '#ff8319',       // 背景色
                    strokeStyle: '#ffffff',     // 軸と補助線の色
                    millisPerLine: 800          // ms/line  補助線間隔
                },
                // maxValue: 1024,                 // 縦軸最大値(省略で自動調整)
                // minValue: 0                     // 縦軸最少値(省略で自動調整)
            });
            //chartオブジェクト(背景/軸)にble_dataオブジェクト(時系列)を紐付け
            chart.addTimeSeries(ble_data, {
                strokeStyle: 'rgba(255, 255, 255, 1)',  // 折れ線の色(A：0透明~1.0不透明)
                fillStyle: 'rgba(255, 255, 255, 0.2)',  // 折れ線より下の領域の色(A：0透明~1.0不透明)
                lineWidth: 4                            // 折れ線の太さ
            });
            //chartオブジェクトをcanvas(HTMLのCANVASオブジェクト)に紐付け
            chart.streamTo(document.getElementById("canvas"), 500); // ms 遅延バッファ
        }
        
        //--------------------------------------------------
        //ロード時の処理
        //--------------------------------------------------
        window.onload = function() {
            //初期の文字列表示
            document.getElementById('device_name').innerHTML = "No Device";
            document.getElementById('uuid_name').innerHTML = "No Seervice";
            document.getElementById('data_text').innerHTML = "No Data"
            document.getElementById('status').innerHTML = "No Connection"

            //UUIDの設定
            ble.setUUID("GasLevelUUID", "0000180d-0000-1000-8000-00805f9b34fb", "00002a37-0000-1000-8000-00805f9b34fb");
        
            //Smooth Charts初期化
            initSmoothCharts();
        }


        //--------------------------------------------------
        //Scan後の処理
        //--------------------------------------------------
        ble.onScan = function(deviceName) {
            //HTMLに表示
            document.getElementById('device_name').innerHTML = deviceName;
            document.getElementById('status').innerHTML = "found device!";
        }

        //--------------------------------------------------
        //ConnectGATT後の処理
        //--------------------------------------------------
        ble.onConnectGATT = function (uuid) {
            console.log('> connected GATT!');

            document.getElementById('uuid_name').innerHTML = uuid;
             document.getElementById('status').innerHTML = "connected GATT!";
        }

        //--------------------------------------------------
        //Read後の処理：得られたデータの表示など行う
        //--------------------------------------------------
        ble.onRead = function(data, uuid) {
            //フォーマットに従って値を取得
            value = data.getInt16(0);//2Byteの場合のフォーマット
 
            //コンソールに値を表示
            console.log(value);
 
            //HTMLに値を表示
            document.getElementById('data_text').innerHTML = value;
 
            document.getElementById('uuid_name').innerHTML = uuid;
            document.getElementById('status').innerHTML = "read data"

            //グラフへ反映
             ble_data.append(new Date().getTime(), value);
        }


        //--------------------------------------------------
        //Start Nortify後の処理
        //--------------------------------------------------
        ble.onStartNotify = function(uuid){
            console.log('> Start Notify!');
 
            document.getElementById('uuid_name').innerHTML = uuid;
            document.getElementById('status').innerHTML = "started Notify";
        }

        //--------------------------------------------------
        //Stop Nortify後の処理
        //--------------------------------------------------
        ble.onStopNotify = function(uuid){
            console.log('> Stop Notify!');
 
            document.getElementById('uuid_name').innerHTML = uuid;
            document.getElementById('status').innerHTML = "stopped Notify";
        }


        //--------------------------------------------------
        //Reset後の処理
        //--------------------------------------------------
        ble.onReset = function() {
            //HTMLに表示
            document.getElementById('device_name').innerHTML = "No Device";
        }

        //-------------------------------------------------
        //ボタンが押された時のイベント登録
        //--------------------------------------------------
        document.getElementById('Start').addEventListener('click', function() {
            ble.startNotify('GasLevelUUID');
        });

        document.getElementById('Stop').addEventListener('click', function() {
            ble.stopNotify('GasLevelUUID');
        });

    </script>
</body>

</html>
